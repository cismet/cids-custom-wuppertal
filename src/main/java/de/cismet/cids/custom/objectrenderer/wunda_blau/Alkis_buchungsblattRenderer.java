/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * Alkis_pointRenderer.java
 *
 * Created on 10.09.2009, 15:52:16
 */
package de.cismet.cids.custom.objectrenderer.wunda_blau;

import de.aedsicad.aaaweb.service.alkis.info.ALKISInfoServices;
import de.aedsicad.aaaweb.service.util.Buchungsblatt;
import de.cismet.cids.custom.objectrenderer.utils.alkis.SOAPAccessProvider;
import de.cismet.cids.dynamics.CidsBean;
import de.cismet.cids.tools.metaobjectrenderer.CidsBeanRenderer;
import de.cismet.tools.CismetThreadPool;
import de.cismet.tools.collections.TypeSafeCollections;
import de.cismet.tools.gui.FooterComponentProvider;
import de.cismet.tools.gui.StaticSwingTools;
import de.cismet.tools.gui.TitleComponentProvider;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.List;
import java.util.logging.Level;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.SwingWorker;
import javax.swing.Timer;
import org.jdesktop.swingx.error.ErrorInfo;

/**
 *
 * @author srichter
 */
public class Alkis_buchungsblattRenderer extends javax.swing.JPanel implements CidsBeanRenderer, TitleComponentProvider, FooterComponentProvider {

    private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(Alkis_buchungsblattRenderer.class);
    private final List<JLabel> retrieveableLabels;
    private SOAPAccessProvider soapProvider;
//    private ALKISSearchServices searchService;
    private ALKISInfoServices infoService;
    private Buchungsblatt buchungsblatt;
    private CidsBean cidsBean;
    private String title;

    /** Creates new form Alkis_pointRenderer */
    public Alkis_buchungsblattRenderer() {
        retrieveableLabels = TypeSafeCollections.newArrayList();
        try {
            soapProvider = new SOAPAccessProvider();
//            searchService = soapProvider.getAlkisSearchService();
            infoService = soapProvider.getAlkisInfoService();
        } catch (Exception ex) {
            log.fatal(ex, ex);
        }
        initComponents();
        retrieveableLabels.add(lblTxtEigentuemerNachname);
        retrieveableLabels.add(lblTxtFlurstueckcode);
//        retrieveableLabels.add(lblTxtAbmarkung);
//        retrieveableLabels.add(lblTxtModellart);
//        retrieveableLabels.add(lblTxtDienststelle);
//        retrieveableLabels.add(lblTxtLand);
//        retrieveableLabels.add(lblTxtDienststelle);
//        retrieveableLabels.add(lblTxtAnlass);
//        retrieveableLabels.add(lblTxtBemerkungAbmarkung);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;
        bindingGroup = new org.jdesktop.beansbinding.BindingGroup();

        panTitle = new javax.swing.JPanel();
        panFooter = new javax.swing.JPanel();
        lblTxtBuchungsblattcode = new javax.swing.JLabel();
        btnRetrieve = new javax.swing.JButton();
        lblBuchungsblattcode = new javax.swing.JLabel();
        lblTxtEigentuemerNachname = new javax.swing.JLabel();
        lblTxtFlurstueckcode = new javax.swing.JLabel();
        lblEigentuemernachname = new javax.swing.JLabel();
        lblFlurstueckcode = new javax.swing.JLabel();

        panTitle.setOpaque(false);

        javax.swing.GroupLayout panTitleLayout = new javax.swing.GroupLayout(panTitle);
        panTitle.setLayout(panTitleLayout);
        panTitleLayout.setHorizontalGroup(
            panTitleLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 100, Short.MAX_VALUE)
        );
        panTitleLayout.setVerticalGroup(
            panTitleLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 100, Short.MAX_VALUE)
        );

        panFooter.setOpaque(false);

        javax.swing.GroupLayout panFooterLayout = new javax.swing.GroupLayout(panFooter);
        panFooter.setLayout(panFooterLayout);
        panFooterLayout.setHorizontalGroup(
            panFooterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 100, Short.MAX_VALUE)
        );
        panFooterLayout.setVerticalGroup(
            panFooterLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 100, Short.MAX_VALUE)
        );

        setLayout(new java.awt.GridBagLayout());

        org.jdesktop.beansbinding.Binding binding = org.jdesktop.beansbinding.Bindings.createAutoBinding(org.jdesktop.beansbinding.AutoBinding.UpdateStrategy.READ, this, org.jdesktop.beansbinding.ELProperty.create("${cidsBean.buchungsblattcode}"), lblTxtBuchungsblattcode, org.jdesktop.beansbinding.BeanProperty.create("text"));
        binding.setSourceNullValue("-");
        binding.setSourceUnreadableValue("<Error>");
        bindingGroup.addBinding(binding);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(lblTxtBuchungsblattcode, gridBagConstraints);

        btnRetrieve.setText(org.openide.util.NbBundle.getMessage(Alkis_buchungsblattRenderer.class, "Alkis_buchungsblattRenderer.btnRetrieve.text")); // NOI18N
        btnRetrieve.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnRetrieveActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.gridwidth = 2;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(btnRetrieve, gridBagConstraints);

        lblBuchungsblattcode.setText(org.openide.util.NbBundle.getMessage(Alkis_buchungsblattRenderer.class, "Alkis_buchungsblattRenderer.lblBuchungsblattcode.text")); // NOI18N
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(lblBuchungsblattcode, gridBagConstraints);

        lblTxtEigentuemerNachname.setText(org.openide.util.NbBundle.getMessage(Alkis_buchungsblattRenderer.class, "Alkis_buchungsblattRenderer.lblTxtEigentuemerNachname.text")); // NOI18N
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(lblTxtEigentuemerNachname, gridBagConstraints);

        lblTxtFlurstueckcode.setText(org.openide.util.NbBundle.getMessage(Alkis_buchungsblattRenderer.class, "Alkis_buchungsblattRenderer.lblTxtFlurstueckcode.text")); // NOI18N
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(lblTxtFlurstueckcode, gridBagConstraints);

        lblEigentuemernachname.setText(org.openide.util.NbBundle.getMessage(Alkis_buchungsblattRenderer.class, "Alkis_buchungsblattRenderer.lblEigentuemernachname.text")); // NOI18N
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(lblEigentuemernachname, gridBagConstraints);

        lblFlurstueckcode.setText(org.openide.util.NbBundle.getMessage(Alkis_buchungsblattRenderer.class, "Alkis_buchungsblattRenderer.lblFlurstueckcode.text")); // NOI18N
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        add(lblFlurstueckcode, gridBagConstraints);

        bindingGroup.bind();
    }// </editor-fold>//GEN-END:initComponents

    private void btnRetrieveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnRetrieveActionPerformed
        final CidsBean bean = cidsBean;
        if (bean != null) {
            final StringBuffer buchungsblattCode = new StringBuffer(String.valueOf(bean.getProperty("buchungsblattcode")));
            //Fix SICAD-SOAP-API-strangeness...
            while(buchungsblattCode.length() < 14) {
                buchungsblattCode.append(" ");
            }
            if (buchungsblattCode != null) {
                CismetThreadPool.execute(new RetrieveWorker(buchungsblattCode.toString()));
            }
        }
    }//GEN-LAST:event_btnRetrieveActionPerformed

    @Override
    public CidsBean getCidsBean() {
        return cidsBean;
    }

    @Override
    public void setCidsBean(CidsBean cb) {
        if (cb != null) {
            this.cidsBean = cb;
            bindingGroup.unbind();
            bindingGroup.bind();
        }
    }

    @Override
    public String getTitle() {
        return title;
    }

    @Override
    public void setTitle(String title) {
        this.title = title;
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnRetrieve;
    private javax.swing.JLabel lblBuchungsblattcode;
    private javax.swing.JLabel lblEigentuemernachname;
    private javax.swing.JLabel lblFlurstueckcode;
    private javax.swing.JLabel lblTxtBuchungsblattcode;
    private javax.swing.JLabel lblTxtEigentuemerNachname;
    private javax.swing.JLabel lblTxtFlurstueckcode;
    private javax.swing.JPanel panFooter;
    private javax.swing.JPanel panTitle;
    private org.jdesktop.beansbinding.BindingGroup bindingGroup;
    // End of variables declaration//GEN-END:variables

    @Override
    public JComponent getTitleComponent() {
        return panTitle;
    }

    @Override
    public JComponent getFooterComponent() {
        return panFooter;
    }

    final class RetrieveWorker extends SwingWorker<Buchungsblatt, Void> {

        public RetrieveWorker(String pointCode) {
            this.buchungsBlattCode = pointCode;
            timer = new Timer(250, new ActionListener() {

                @Override
                public void actionPerformed(ActionEvent e) {
                    if (waitStat.length() < 11) {
                        waitStat += ".";
                    } else {
                        waitStat = ".";
                    }
                    for (final JLabel label : retrieveableLabels) {
                        label.setText(waitStat);
                    }
                }
            });
            btnRetrieve.setVisible(false);
            timer.start();
        }
        private final String buchungsBlattCode;
        private String waitStat = "";
        private final Timer timer;

        @Override
        protected Buchungsblatt doInBackground() throws Exception {

            return infoService.getBuchungsblatt(soapProvider.getIdentityCard(), soapProvider.getService(), buchungsBlattCode);
        }

        private final void restoreOnException() {
            btnRetrieve.setVisible(true);
            for (JLabel label : retrieveableLabels) {
                label.setText("...");
            }
        }

        @Override
        protected void done() {
            timer.stop();
            try {
                final Buchungsblatt buchungsblatt = get();
                if (buchungsblatt != null) {
                    Alkis_buchungsblattRenderer.this.buchungsblatt = buchungsblatt;
//                    Alkis_buchungsblattRenderer.this.bindingGroup.unbind();
//                    Alkis_buchungsblattRenderer.this.bindingGroup.bind();

                    //TODO this is quick and dirty for tesing only!
                    lblTxtEigentuemerNachname.setText(buchungsblatt.getOwners()[0].getSurName());
                    
//                    lblTxtModellart.setText(point.getModellArt());
//                    lblTxtDienststelle.setText(point.getZustaendigeStelleStelle());
//                    lblTxtLand.setText(point.getZustaendigeStelleLand());
//                    lblTxtBeginn.setText(point.getLebenszeitIntervallBeginnt());
//                    lblTxtEnde.setText(point.getLebenszeitIntervallEndet());
//                    lblTxtAnlass.setText(point.getAnlass());
//                    lblTxtBemerkungAbmarkung.setText(point.getBemerkungZurAbmarkungName());
                }
            } catch (InterruptedException ex) {
                restoreOnException();
                log.warn(ex, ex);
            } catch (Exception ex) {
                //TODO show error message to user?
                restoreOnException();
                org.jdesktop.swingx.error.ErrorInfo ei = new ErrorInfo("Fehler beim Retrieve", ex.getMessage(), null, null, ex, Level.ALL, null);
                org.jdesktop.swingx.JXErrorPane.showDialog(StaticSwingTools.getParentFrame(Alkis_buchungsblattRenderer.this), ei);
                log.error(ex, ex);
            }
        }
    }
}
