/***************************************************
*
* cismet GmbH, Saarbruecken, Germany
*
*              ... and it just works.
*
****************************************************/
/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package de.cismet.cids.custom.objecteditors.wunda_blau.albo;

import java.awt.event.KeyEvent;

import java.util.Arrays;

import javax.swing.JComboBox;
import javax.swing.JTable;
import javax.swing.ListSelectionModel;
import javax.swing.RowFilter;
import javax.swing.RowSorter;
import javax.swing.SortOrder;
import javax.swing.SwingUtilities;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.TableRowSorter;

import de.cismet.tools.gui.StaticSwingTools;

/**
 * DOCUMENT ME!
 *
 * @author   jruiz
 * @version  $Revision$, $Date$
 */
public class ComboBoxFilterDialog extends javax.swing.JDialog {

    //~ Instance fields --------------------------------------------------------

    private final JComboBox comboBox;

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnApply;
    private javax.swing.JButton btnCancel;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable table;
    private javax.swing.JTextField txtFilter;
    // End of variables declaration//GEN-END:variables

    //~ Constructors -----------------------------------------------------------

    /**
     * Creates a new ComboBoxFilterDialog object.
     *
     * @param  comboBox  DOCUMENT ME!
     */
    public ComboBoxFilterDialog(final JComboBox comboBox) {
        this(comboBox, null);
    }

    /**
     * Creates new form ComboBoxFilterDialog.
     *
     * @param  comboBox  DOCUMENT ME!
     * @param  title     DOCUMENT ME!
     */
    public ComboBoxFilterDialog(final JComboBox comboBox, final String title) {
        this.comboBox = comboBox;
        initComponents();
        setTitle((title != null) ? title : "Auswahlfilter");

        final TableRowSorter sorter = new TableRowSorter(getSelectionTableModel());
        sorter.setSortKeys(Arrays.asList(new RowSorter.SortKey(0, SortOrder.ASCENDING)));
        sorter.setRowFilter(new RowFilter<TableModel, Integer>() {

                @Override
                public boolean include(final RowFilter.Entry<? extends TableModel, ? extends Integer> entry) {
                    final String filterText = txtFilter.getText().trim();
                    if ((entry == null) || (entry.getValue(0) == null)) {
                        return false;
                    } else if (filterText.isEmpty()) {
                        return true;
                    } else {
                        return (entry.getValue(0)).toString().toLowerCase().contains(filterText.toLowerCase());
                    }
                }
            });
        getTable().setRowSorter(sorter);

        getSelectionModel().addListSelectionListener(new ListSelectionListener() {

                @Override
                public void valueChanged(final ListSelectionEvent e) {
                    if (!e.getValueIsAdjusting()) {
                        btnApply.setEnabled(e.getFirstIndex() >= 0);
                    }
                }
            });

        getSelectionTableModel().fireTableDataChanged();
        getRootPane().setDefaultButton(btnApply);
    }

    //~ Methods ----------------------------------------------------------------

    /**
     * DOCUMENT ME!
     *
     * @return  DOCUMENT ME!
     */
    private TableModel getSelectionTableModel() {
        return (TableModel)table.getModel();
    }

    /**
     * DOCUMENT ME!
     *
     * @return  DOCUMENT ME!
     */
    private TableRowSorter getRowSorter() {
        return (TableRowSorter)table.getRowSorter();
    }

    /**
     * DOCUMENT ME!
     *
     * @return  DOCUMENT ME!
     */
    private ListSelectionModel getSelectionModel() {
        return table.getSelectionModel();
    }

    /**
     * DOCUMENT ME!
     *
     * @return  DOCUMENT ME!
     */
    private JTable getTable() {
        return table;
    }

    /**
     * DOCUMENT ME!
     *
     * @return  DOCUMENT ME!
     */
    private JComboBox getComboBox() {
        return comboBox;
    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The
     * content of this method is always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        table = new javax.swing.JTable();
        txtFilter = new javax.swing.JTextField();
        jPanel2 = new javax.swing.JPanel();
        btnApply = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setModal(true);
        getContentPane().setLayout(new java.awt.GridBagLayout());

        jPanel1.setLayout(new java.awt.GridBagLayout());

        table.setModel(new TableModel());
        table.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        table.setShowHorizontalLines(false);
        table.setShowVerticalLines(false);
        table.setTableHeader(null);
        table.addKeyListener(new java.awt.event.KeyAdapter() {

                @Override
                public void keyPressed(final java.awt.event.KeyEvent evt) {
                    tableKeyPressed(evt);
                }
            });
        jScrollPane1.setViewportView(table);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weighty = 1.0;
        jPanel1.add(jScrollPane1, gridBagConstraints);

        txtFilter.setText(org.openide.util.NbBundle.getMessage(
                ComboBoxFilterDialog.class,
                "ComboBoxFilterDialog.txtFilter.text")); // NOI18N
        txtFilter.addKeyListener(new java.awt.event.KeyAdapter() {

                @Override
                public void keyTyped(final java.awt.event.KeyEvent evt) {
                    txtFilterKeyTyped(evt);
                }
                @Override
                public void keyPressed(final java.awt.event.KeyEvent evt) {
                    txtFilterKeyPressed(evt);
                }
            });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        jPanel1.add(txtFilter, gridBagConstraints);

        jPanel2.setLayout(new java.awt.GridBagLayout());

        org.openide.awt.Mnemonics.setLocalizedText(
            btnApply,
            org.openide.util.NbBundle.getMessage(ComboBoxFilterDialog.class, "ComboBoxFilterDialog.btnApply.text")); // NOI18N
        btnApply.setEnabled(false);
        btnApply.addActionListener(new java.awt.event.ActionListener() {

                @Override
                public void actionPerformed(final java.awt.event.ActionEvent evt) {
                    btnApplyActionPerformed(evt);
                }
            });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.insets = new java.awt.Insets(0, 0, 0, 5);
        jPanel2.add(btnApply, gridBagConstraints);

        org.openide.awt.Mnemonics.setLocalizedText(
            btnCancel,
            org.openide.util.NbBundle.getMessage(ComboBoxFilterDialog.class, "ComboBoxFilterDialog.btnCancel.text")); // NOI18N
        btnCancel.addActionListener(new java.awt.event.ActionListener() {

                @Override
                public void actionPerformed(final java.awt.event.ActionEvent evt) {
                    btnCancelActionPerformed(evt);
                }
            });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 0, 0);
        jPanel2.add(btnCancel, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.LAST_LINE_END;
        gridBagConstraints.insets = new java.awt.Insets(10, 0, 0, 0);
        jPanel1.add(jPanel2, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(10, 10, 10, 10);
        getContentPane().add(jPanel1, gridBagConstraints);

        pack();
    } // </editor-fold>//GEN-END:initComponents

    /**
     * DOCUMENT ME!
     *
     * @param  evt  DOCUMENT ME!
     */
    private void tableKeyPressed(final java.awt.event.KeyEvent evt) { //GEN-FIRST:event_tableKeyPressed
        if (KeyEvent.VK_ENTER == evt.getKeyCode()) {
            evt.consume();
            btnApplyActionPerformed(null);
        } else if (KeyEvent.VK_UP == evt.getKeyCode()) {
            if (table.getSelectedRow() == 0) {
                txtFilter.requestFocus();
            }
        } else if (KeyEvent.VK_LEFT == evt.getKeyCode()) {
            txtFilter.requestFocus();
        } else if (KeyEvent.VK_ESCAPE == evt.getKeyCode()) {
            dispose();
        }
    }                                                                 //GEN-LAST:event_tableKeyPressed

    /**
     * DOCUMENT ME!
     *
     * @param  evt  DOCUMENT ME!
     */
    private void txtFilterKeyTyped(final java.awt.event.KeyEvent evt) { //GEN-FIRST:event_txtFilterKeyTyped
        SwingUtilities.invokeLater(new Runnable() {

                @Override
                public void run() {
                    getRowSorter().sort();

                    final boolean singleSelected = getRowSorter().getViewRowCount() == 1;
                    final int rowIndex = singleSelected ? 0 : -1;
                    getSelectionModel().setSelectionInterval(rowIndex, rowIndex);
                    btnApply.setEnabled(singleSelected);
                }
            });
    } //GEN-LAST:event_txtFilterKeyTyped

    /**
     * DOCUMENT ME!
     *
     * @param  evt  DOCUMENT ME!
     */
    private void txtFilterKeyPressed(final java.awt.event.KeyEvent evt) { //GEN-FIRST:event_txtFilterKeyPressed
        if ((KeyEvent.VK_DOWN == evt.getKeyCode()) || (KeyEvent.VK_RIGHT == evt.getKeyCode())) {
            getTable().requestFocus();
            getSelectionModel().setSelectionInterval(0, 0);
        } else if (KeyEvent.VK_ESCAPE == evt.getKeyCode()) {
            dispose();
        }
    }                                                                     //GEN-LAST:event_txtFilterKeyPressed

    /**
     * DOCUMENT ME!
     *
     * @param  evt  DOCUMENT ME!
     */
    private void btnApplyActionPerformed(final java.awt.event.ActionEvent evt) { //GEN-FIRST:event_btnApplyActionPerformed
        if (getTable().getSelectedRow() >= 0) {
            final RowSorter rowSorter = getRowSorter();
            getComboBox().setSelectedIndex(rowSorter.convertRowIndexToModel(getTable().getSelectedRow()));
            dispose();
        }
    }                                                                            //GEN-LAST:event_btnApplyActionPerformed

    /**
     * DOCUMENT ME!
     *
     * @param  evt  DOCUMENT ME!
     */
    private void btnCancelActionPerformed(final java.awt.event.ActionEvent evt) { //GEN-FIRST:event_btnCancelActionPerformed
        dispose();
    }                                                                             //GEN-LAST:event_btnCancelActionPerformed

    /**
     * DOCUMENT ME!
     *
     * @param  comboBox  DOCUMENT ME!
     */
    public static void showForCombobox(final JComboBox comboBox) {
        showForCombobox(comboBox, null);
    }

    /**
     * DOCUMENT ME!
     *
     * @param  comboBox  DOCUMENT ME!
     * @param  title     DOCUMENT ME!
     */
    public static void showForCombobox(final JComboBox comboBox, final String title) {
        StaticSwingTools.showDialog(new ComboBoxFilterDialog(comboBox, title), true);
    }

    //~ Inner Classes ----------------------------------------------------------

    /**
     * DOCUMENT ME!
     *
     * @version  $Revision$, $Date$
     */
    class TableModel extends AbstractTableModel {

        //~ Methods ------------------------------------------------------------

        @Override
        public int getRowCount() {
            return (comboBox != null) ? comboBox.getModel().getSize() : 0;
        }

        @Override
        public int getColumnCount() {
            return 1;
        }

        @Override
        public Object getValueAt(final int rowIndex, final int columnIndex) {
            return (comboBox != null)
                ? ((comboBox.getModel().getElementAt(rowIndex) != null)
                    ? comboBox.getModel().getElementAt(rowIndex).toString() : null) : null;
        }

        @Override
        public Class<?> getColumnClass(final int columnIndex) {
            return String.class;
        }

        @Override
        public String getColumnName(final int column) {
            return null;
        }
    }
}
